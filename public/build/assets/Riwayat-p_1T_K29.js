import{C as z,H as A,o as Y,c as d,a as v,u as H,h as I,m as J,b as t,f as w,v as N,x as W,t as a,j as r,F as S,s as E,n as q,e as g,w as K,d as Q,r as c}from"./app-Bbu4H21f.js";import{_ as X}from"./AdminLayout-ryQMfyJt.js";import{_ as T}from"./LoadingSpinner-00j7UtxD.js";const Z={class:"text-slate-800 dark:text-slate-100 pb-24"},tt={class:"sticky top-0 z-30 w-full mb-4"},et={class:"relative max-w-4xl mx-auto px-3 sm:px-5 pb-2 sm:pb-3 pt-2 space-y-2"},st={class:"flex items-center justify-between"},at={class:"flex items-center gap-2"},lt={class:"grid grid-cols-1 sm:grid-cols-4 gap-2"},ot={class:"sm:col-span-2"},nt={class:"flex gap-2"},it={class:"grid grid-cols-2 sm:grid-cols-4 gap-2"},dt={class:"col-span-2 flex items-end justify-end text-xs text-slate-500 dark:text-slate-400 font-bold"},rt={class:"max-w-4xl mx-auto px-3 sm:px-5 space-y-3"},ut={key:0,class:"py-10 text-center text-slate-500"},ct={key:1,class:"text-center py-16 sm:py-20"},xt={key:2,class:"grid grid-cols-1 md:grid-cols-2 gap-3"},pt=["onClick"],bt={class:"flex items-center justify-between gap-2"},ft={class:"font-black text-slate-900 dark:text-slate-100"},vt={class:"text-xs text-slate-600 dark:text-slate-300 mt-1"},gt={class:"text-xs text-slate-600 dark:text-slate-300 mt-1"},mt={class:"flex items-center justify-between mt-3 text-[10px] text-slate-500 dark:text-slate-400 font-bold"},_t={key:3,class:"flex items-center justify-between gap-3 pt-2"},kt=["disabled"],yt={class:"text-xs text-slate-500 dark:text-slate-400 font-bold"},ht=["disabled"],wt={class:"bg-white dark:bg-slate-900 w-full max-w-2xl rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh] border border-slate-200 dark:border-white/10"},St={class:"bg-slate-50 dark:bg-slate-900 px-5 py-4 border-b border-slate-200 dark:border-white/10 flex justify-between items-center"},Ct={class:"text-[10px] text-slate-400 font-bold"},jt={class:"p-5 overflow-y-auto text-sm bg-slate-50/50 dark:bg-slate-900/50 space-y-4"},Dt={key:0,class:"py-10 text-center text-slate-500"},Nt={class:"card p-4"},Tt={class:"grid grid-cols-1 sm:grid-cols-2 gap-3 text-xs"},$t={class:"font-bold"},Ft={class:"font-bold"},Bt={class:"sm:col-span-2"},Pt={class:"font-bold"},Rt={class:"font-bold"},Mt={class:"font-bold"},Vt={class:"font-bold"},At={class:"font-bold"},Et={class:"card p-4"},Gt={class:"text-[11px] text-slate-600 dark:text-slate-300 whitespace-pre-wrap break-words"},Lt={class:"card p-4"},Ot={class:"flex items-center justify-between"},Ut={key:0,class:"text-xs text-slate-500"},zt={class:"mt-3 space-y-2"},Yt={key:0,class:"italic text-xs text-slate-400"},Ht={class:"text-[10px] text-slate-400 mb-1"},It={class:"text-xs text-slate-700 dark:text-slate-200"},Jt={class:"font-bold"},Wt={class:"text-slate-500 dark:text-slate-400"},qt={class:"text-slate-800 dark:text-slate-100 font-bold"},$=20,Zt={__name:"Riwayat",props:{initialFilters:{type:Object,default:()=>({})}},setup(G){const m=z("toast"),_=G,b=c(!1),k=c([]),i=A({page:1,per_page:$,total:0,total_pages:1}),o=A({search:_.initialFilters.q||"",status:_.initialFilters.status||"",date_from:_.initialFilters.date_from||"",date_to:_.initialFilters.date_to||""});let C=null;function F(n){return String(n).padStart(2,"0")}function B(n){return`${n.getFullYear()}-${F(n.getMonth()+1)}-${F(n.getDate())}`}function P(n){if(!n)return"-";const e=String(n).includes("T")?String(n):String(n).replace(" ","T"),l=new Date(e);return Number.isNaN(l.getTime())?String(n):l.toLocaleString("id-ID")}async function j(n){const l=await(await fetch(n,{credentials:"same-origin"})).json().catch(()=>null);if(!l)throw new Error("Response JSON tidak valid");return l}async function f(n=1){b.value=!0;try{const e=new URLSearchParams;e.set("page",String(n)),e.set("per_page",String($)),o.search&&e.set("search",o.search),o.status&&e.set("status",o.status),o.date_from&&e.set("date_from",o.date_from),o.date_to&&e.set("date_to",o.date_to);const l=await j(`/api/v1/installations/riwayat?${e.toString()}`);if(l.status!=="success")throw new Error(l.msg||"Gagal memuat data");k.value=Array.isArray(l.data)?l.data:[],i.page=Number(l.page||1),i.per_page=Number(l.per_page||$),i.total=Number(l.total||0),i.total_pages=Number(l.total_pages||1)}catch(e){console.error(e),k.value=[],m&&m.error(e.message||"Gagal memuat riwayat")}finally{b.value=!1}}function x(){i.page=1,f(1)}function L(){C&&clearTimeout(C),C=setTimeout(()=>x(),350)}function O(){o.search="",x()}function R(n=!0){const e=new Date,l=new Date(e.getFullYear(),e.getMonth(),1),s=new Date(e.getFullYear(),e.getMonth()+1,0);o.date_from=B(l),o.date_to=B(s),n&&x()}const y=c(!1),D=c(!1),u=c(null),h=c(!1),p=c([]);async function U(n){y.value=!0,D.value=!0,p.value=[];try{const e=await j(`/api/v1/installations/${n}`);if(e.status!=="success"||!e.data)throw new Error(e.msg||"Data tidak ditemukan");u.value=e.data,h.value=!0;try{const l=await j(`/api/v1/installations/${n}/history`);p.value=l.status==="success"?l.data||[]:[]}catch{p.value=[]}finally{h.value=!1}}catch(e){m&&m.error(e.message||"Gagal memuat detail"),y.value=!1}finally{D.value=!1}}function M(){y.value=!1,u.value=null,p.value=[]}return Y(()=>{!o.date_from&&!o.date_to&&R(!1),f(1)}),(n,e)=>(r(),d(S,null,[v(H(I),{title:"Riwayat Pemasangan"}),v(X,null,{default:J(()=>{var l;return[t("div",Z,[t("div",tt,[e[12]||(e[12]=t("div",{class:"absolute inset-x-0 top-0 bottom-0 bg-slate-50/95 dark:bg-slate-900/90 backdrop-blur border-b border-slate-200 dark:border-white/10 pointer-events-none"},null,-1)),t("div",et,[t("div",st,[e[8]||(e[8]=t("div",null,[t("h2",{class:"text-sm font-black text-slate-800 dark:text-slate-100"},"Riwayat"),t("p",{class:"text-[10px] text-slate-400 dark:text-slate-500 font-bold uppercase"},"Selesai & Batal")],-1)),t("div",at,[t("button",{onClick:e[0]||(e[0]=s=>f(i.page)),class:"h-10 w-10 flex items-center justify-center bg-white dark:bg-slate-900 border border-slate-200 dark:border-white/10 rounded-xl text-slate-600 dark:text-slate-300 shadow-sm hover:bg-blue-50 dark:hover:bg-white/5 transition",type:"button",title:"Refresh"}," ↻ ")])]),t("div",lt,[t("div",ot,[w(t("input",{"onUpdate:modelValue":e[1]||(e[1]=s=>o.search=s),onInput:L,class:"input w-full",placeholder:"Cari ticket/nama/alamat"},null,544),[[N,o.search]])]),t("div",null,[w(t("select",{"onUpdate:modelValue":e[2]||(e[2]=s=>o.status=s),class:"input w-full",onChange:x},[...e[9]||(e[9]=[t("option",{value:""},"Selesai + Batal",-1),t("option",{value:"Selesai"},"Selesai",-1),t("option",{value:"Batal"},"Batal",-1)])],544),[[W,o.status]])]),t("div",nt,[t("button",{class:"btn btn-secondary w-full",type:"button",onClick:e[3]||(e[3]=s=>R(!0))},"Bulan ini"),t("button",{class:"btn btn-secondary",type:"button",onClick:O},"Clear")])]),t("div",it,[t("div",null,[e[10]||(e[10]=t("label",{class:"text-[10px] font-bold text-slate-500 dark:text-slate-400"},"Dari",-1)),w(t("input",{"onUpdate:modelValue":e[4]||(e[4]=s=>o.date_from=s),type:"date",class:"input w-full",onChange:x},null,544),[[N,o.date_from]])]),t("div",null,[e[11]||(e[11]=t("label",{class:"text-[10px] font-bold text-slate-500 dark:text-slate-400"},"Sampai",-1)),w(t("input",{"onUpdate:modelValue":e[5]||(e[5]=s=>o.date_to=s),type:"date",class:"input w-full",onChange:x},null,544),[[N,o.date_to]])]),t("div",dt," Total: "+a(i.total),1)])])]),t("div",rt,[b.value?(r(),d("div",ut,[v(T)])):k.value.length===0?(r(),d("div",ct,[...e[13]||(e[13]=[t("div",{class:"w-20 h-20 bg-slate-200 dark:bg-slate-800 rounded-full flex items-center justify-center mx-auto mb-4 text-slate-400 dark:text-slate-500"},"✓",-1),t("h3",{class:"text-slate-600 dark:text-slate-300 font-bold text-base"},"Tidak ada riwayat",-1)])])):(r(),d("div",xt,[(r(!0),d(S,null,E(k.value,s=>(r(),d("button",{key:s.id,type:"button",class:"card p-4 text-left hover:ring-2 hover:ring-primary-500 transition",onClick:V=>U(s.id)},[t("div",bt,[t("div",ft,a(s.customer_name||"-"),1),t("span",{class:q([s.status==="Selesai"?"bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400":"bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400","px-2 py-1 rounded-lg text-xs font-bold"])},a(s.status||"-"),3)]),t("div",vt,"#"+a(s.ticket_id||"-")+" • WA: "+a(s.customer_phone||"-"),1),t("div",gt,a(s.address||"-"),1),t("div",mt,[t("div",null,"POP: "+a(s.pop||"-"),1),t("div",null,a(P(s.finished_at)),1)])],8,pt))),128))])),i.total_pages>1?(r(),d("div",_t,[t("button",{onClick:e[6]||(e[6]=s=>f(i.page-1)),disabled:i.page===1||b.value,class:"btn btn-secondary",type:"button"},"Prev",8,kt),t("div",yt,"Halaman "+a(i.page)+" / "+a(i.total_pages),1),t("button",{onClick:e[7]||(e[7]=s=>f(i.page+1)),disabled:i.page===i.total_pages||b.value,class:"btn btn-secondary",type:"button"},"Next",8,ht)])):g("",!0)]),y.value?(r(),d("div",{key:0,class:"fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm",onClick:K(M,["self"])},[t("div",wt,[t("div",St,[t("div",null,[e[14]||(e[14]=t("h3",{class:"font-black text-lg text-slate-800 dark:text-slate-100"},"Detail Riwayat",-1)),t("div",Ct,a((l=u.value)!=null&&l.ticket_id?"#"+u.value.ticket_id:""),1)]),t("button",{onClick:M,class:"h-9 w-9 flex items-center justify-center rounded-xl bg-white dark:bg-slate-800 border border-slate-200 dark:border-white/10 text-slate-500 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700 transition",type:"button"},"✕")]),t("div",jt,[D.value?(r(),d("div",Dt,[v(T)])):u.value?(r(),d(S,{key:1},[t("div",Nt,[t("div",Tt,[t("div",null,[e[15]||(e[15]=t("div",{class:"text-[10px] text-slate-500 dark:text-slate-400 font-bold"},"Nama",-1)),t("div",$t,a(u.value.customer_name||"-"),1)]),t("div",null,[e[16]||(e[16]=t("div",{class:"text-[10px] text-slate-500 dark:text-slate-400 font-bold"},"WA",-1)),t("div",Ft,a(u.value.customer_phone||"-"),1)]),t("div",Bt,[e[17]||(e[17]=t("div",{class:"text-[10px] text-slate-500 dark:text-slate-400 font-bold"},"Alamat",-1)),t("div",Pt,a(u.value.address||"-"),1)]),t("div",null,[e[18]||(e[18]=t("div",{class:"text-[10px] text-slate-500 dark:text-slate-400 font-bold"},"POP",-1)),t("div",Rt,a(u.value.pop||"-"),1)]),t("div",null,[e[19]||(e[19]=t("div",{class:"text-[10px] text-slate-500 dark:text-slate-400 font-bold"},"Status",-1)),t("div",Mt,a(u.value.status||"-"),1)]),t("div",null,[e[20]||(e[20]=t("div",{class:"text-[10px] text-slate-500 dark:text-slate-400 font-bold"},"Tanggal Install",-1)),t("div",Vt,a(u.value.installation_date||"-"),1)]),t("div",null,[e[21]||(e[21]=t("div",{class:"text-[10px] text-slate-500 dark:text-slate-400 font-bold"},"Selesai/Batal",-1)),t("div",At,a(P(u.value.finished_at)),1)])])]),t("div",Et,[e[22]||(e[22]=t("div",{class:"text-xs font-black text-slate-800 dark:text-slate-100 mb-2"},"Catatan",-1)),t("pre",Gt,a(u.value.notes||"-"),1)]),t("div",Lt,[t("div",Ot,[e[23]||(e[23]=t("div",{class:"text-xs font-black text-slate-800 dark:text-slate-100"},"Riwayat Perubahan Data",-1)),h.value?(r(),d("div",Ut,[v(T,{size:"sm"})])):g("",!0)]),t("div",zt,[!h.value&&p.value.length===0?(r(),d("div",Yt,"Belum ada perubahan.")):g("",!0),(r(!0),d(S,null,E(p.value,(s,V)=>(r(),d("div",{key:V,class:"border-b border-slate-200 dark:border-white/10 pb-2"},[t("div",Ht,a(s.changed_at||"-")+" - "+a(s.changed_by||"-")+" ("+a(s.changed_by_role||"-")+") via "+a(s.source||"-"),1),t("div",It,[t("span",Jt,a(s.field_name||"-"),1),e[24]||(e[24]=Q(": ",-1)),t("span",Wt,a((s.old_value||"-").toString().trim()||"-"),1),e[25]||(e[25]=t("span",{class:"text-slate-400 px-1"},"->",-1)),t("span",qt,a((s.new_value||"-").toString().trim()||"-"),1)])]))),128))])])],64)):g("",!0)])])])):g("",!0)])]}),_:1})],64))}};export{Zt as default};
